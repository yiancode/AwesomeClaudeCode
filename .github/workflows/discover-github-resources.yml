name: Discover GitHub Resources

on:
  schedule:
    # æ¯å¤© UTC 2:00 è¿è¡Œ Topics å‘ç°
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      discovery_type:
        description: 'Discovery type to run'
        required: true
        default: 'topics'
        type: choice
        options:
          - topics
          - related
          - trends
          - all
      limit:
        description: 'Maximum resources to discover'
        required: false
        default: '10'
        type: string
      dry_run:
        description: 'Dry run (do not modify files)'
        required: false
        default: false
        type: boolean

jobs:
  discover-topics:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.discovery_type == 'topics' || github.event.inputs.discovery_type == 'all'))

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Discover by Topics
        id: discover
        run: |
          LIMIT="${{ github.event.inputs.limit || '10' }}"
          DRY_RUN="${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}"

          python scripts/discover_github_topics.py --limit $LIMIT $DRY_RUN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.verify_diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/
          git commit -m "feat: è‡ªåŠ¨å‘ç°æ–°èµ„æº (Topics) [skip ci]"
          git push

      - name: Create summary Issue
        if: steps.verify_diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];

            const issueBody = [
              '## ğŸ“¦ æ–°å‘ç°çš„å€™é€‰èµ„æº',
              '',
              'æœ¬æ¬¡é€šè¿‡ **GitHub Topics** æœç´¢å‘ç°äº†æ–°çš„å€™é€‰èµ„æºã€‚',
              '',
              '### åç»­æ­¥éª¤',
              '1. æŸ¥çœ‹ `candidates/pending_resources.json` ä¸­çš„æ–°èµ„æº',
              '2. ä½¿ç”¨ `python scripts/create_resource_pr.py --list` æŸ¥çœ‹å¾…å®¡æ ¸åˆ—è¡¨',
              '3. å®¡æ ¸é€šè¿‡åè¿è¡Œ `python scripts/create_resource_pr.py --all` åˆ›å»º PR',
              '',
              '---',
              'ğŸ¤– ç”± GitHub èµ„æºå‘ç°å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ” è‡ªåŠ¨å‘ç°çš„æ–°èµ„æº - ${date}`,
              body: issueBody,
              labels: ['auto-discovered', 'needs-review']
            });

  discover-related:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.discovery_type == 'related' || github.event.inputs.discovery_type == 'all')

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Discover related repos
        id: discover
        run: |
          LIMIT="${{ github.event.inputs.limit || '10' }}"
          DRY_RUN="${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}"

          python scripts/discover_related_repos.py --limit $LIMIT $DRY_RUN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.verify_diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/
          git commit -m "feat: è‡ªåŠ¨å‘ç°å…³è”é¡¹ç›® [skip ci]"
          git push

  analyze-trends:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.discovery_type == 'trends' || github.event.inputs.discovery_type == 'all')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Analyze trends
        id: analyze
        run: |
          LIMIT="${{ github.event.inputs.limit || '50' }}"

          python scripts/analyze_github_trends.py \
            --report \
            --update-history \
            --limit $LIMIT \
            --output trends_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8

      - name: Upload trends report
        uses: actions/upload-artifact@v4
        with:
          name: trends-report
          path: trends_report.md
          retention-days: 30

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit history updates
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/trends_history.json
          git commit -m "chore: æ›´æ–°è¶‹åŠ¿å†å²æ•°æ® [skip ci]" || true
          git push

  # æ¯å‘¨è¿è¡Œä¸€æ¬¡å®Œæ•´åˆ†æ
  weekly-full-analysis:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 0'  # æ¯å‘¨æ—¥ UTC 2:00

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run full discovery
        run: |
          echo "ğŸ” Running Topics discovery..."
          python scripts/discover_github_topics.py --limit 20

          echo "ğŸ”— Running Related discovery..."
          python scripts/discover_related_repos.py --limit 10

          echo "ğŸ“ˆ Running Trends analysis..."
          python scripts/analyze_github_trends.py --report --update-history --output trends_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit all changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/
          git commit -m "feat: æ¯å‘¨èµ„æºè‡ªåŠ¨å‘ç°ä¸è¶‹åŠ¿åˆ†æ [skip ci]"
          git push

      - name: Create weekly summary Issue
        if: steps.verify_diff.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            let trendsReport = '';
            try {
              trendsReport = fs.readFileSync('trends_report.md', 'utf8');
            } catch (e) {
              trendsReport = '*è¶‹åŠ¿æŠ¥å‘Šç”Ÿæˆå¤±è´¥*';
            }

            const issueBody = [
              '## ğŸ” æ¯å‘¨è‡ªåŠ¨å‘ç°æ‘˜è¦',
              '',
              'æœ¬å‘¨é€šè¿‡è‡ªåŠ¨åŒ–æµç¨‹å‘ç°äº†æ–°çš„å€™é€‰èµ„æºã€‚',
              '',
              '### å‘ç°æ¥æº',
              '- GitHub Topics æœç´¢',
              '- å…³è”é¡¹ç›®åˆ†æ',
              '- è¶‹åŠ¿åˆ†æ',
              '',
              '### è¶‹åŠ¿æŠ¥å‘Š',
              '',
              trendsReport.substring(0, 60000),
              '',
              '### åç»­æ­¥éª¤',
              '1. æŸ¥çœ‹ `candidates/pending_resources.json`',
              '2. å®¡æ ¸æ–°å‘ç°çš„èµ„æº',
              '3. æ‰¹å‡†ä¼˜è´¨èµ„æº',
              '',
              '---',
              'ğŸ¤– æ¯å‘¨è‡ªåŠ¨ç”Ÿæˆ'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š æ¯å‘¨èµ„æºå‘ç°æŠ¥å‘Š - ${date}`,
              body: issueBody,
              labels: ['auto-discovered', 'weekly-report', 'needs-review']
            });
