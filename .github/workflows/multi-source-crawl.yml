name: Multi-source Resource Crawl

on:
  schedule:
    # æ¯å‘¨ä¸‰å’Œå‘¨å…­ UTC 3:00 è¿è¡Œ
    - cron: '0 3 * * 3,6'
  workflow_dispatch:
    inputs:
      sources:
        description: 'Data sources to crawl'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - reddit
          - awesome
          - rss
          - hackernews
      limit:
        description: 'Maximum resources per source'
        required: false
        default: '10'
        type: string
      dry_run:
        description: 'Dry run (do not modify files)'
        required: false
        default: false
        type: boolean

jobs:
  crawl:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install feedparser  # RSS è§£æå¯é€‰ä¾èµ–

      - name: Run multi-source crawl
        id: crawl
        run: |
          SOURCES="${{ github.event.inputs.sources || 'all' }}"
          LIMIT="${{ github.event.inputs.limit || '10' }}"
          DRY_RUN="${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}"

          python scripts/multi_source_crawl.py \
            --sources $SOURCES \
            --limit $LIMIT \
            $DRY_RUN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.verify_diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/
          git commit -m "feat: å¤šæºèµ„æºçˆ¬å–å‘ç°æ–°èµ„æº [skip ci]"

          # æ¨é€å‰å…ˆæ‹‰å–æœ€æ–°å˜æ›´ï¼Œé¿å…å†²çª
          # Pull latest changes before pushing to avoid conflicts
          echo "æ‹‰å–æœ€æ–°å˜æ›´..."
          git pull --rebase origin ${{ github.ref_name }}

          # æ¨é€å˜æ›´ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
          # Push changes with up to 3 retries
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… æ¨é€æˆåŠŸ"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
                echo "æ‹‰å–æœ€æ–°å˜æ›´..."
                git pull --rebase origin ${{ github.ref_name }}
              fi
            fi
          done

          echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯• $MAX_RETRIES æ¬¡"
          exit 1

      - name: Create summary Issue
        if: steps.verify_diff.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const sources = '${{ github.event.inputs.sources || 'all' }}';

            const issueBody = [
              '## ğŸ“¦ å¤šæºèµ„æºçˆ¬å–ç»“æœ',
              '',
              'æœ¬æ¬¡ä»ä»¥ä¸‹æ•°æ®æºå‘ç°äº†æ–°çš„å€™é€‰èµ„æºï¼š',
              '',
              `**æ•°æ®æº**: ${sources}`,
              '',
              '### æ•°æ®æºè¯´æ˜',
              '- **Reddit**: ä» ClaudeAIã€LocalLLaMA ç­‰ subreddit æœç´¢',
              '- **Awesome Lists**: ä» awesome-mcp-servers ç­‰åˆ—è¡¨æå–',
              '- **RSS**: ä» Anthropic Blogã€HN RSS ç­‰è®¢é˜…æºè·å–',
              '- **Hacker News**: é€šè¿‡ Algolia API æœç´¢',
              '',
              '### åç»­æ­¥éª¤',
              '1. æŸ¥çœ‹ `candidates/pending_resources.json`',
              '2. è¿è¡Œ `python scripts/create_resource_pr.py --list` æŸ¥çœ‹å¾…å®¡æ ¸',
              '3. å®¡æ ¸é€šè¿‡åè¿è¡Œ `python scripts/create_resource_pr.py --all` åˆ›å»º PR',
              '',
              '---',
              'ğŸ¤– ç”±å¤šæºçˆ¬å–å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ•¸ï¸ å¤šæºçˆ¬å–å‘ç°æ–°èµ„æº - ${date}`,
              body: issueBody,
              labels: ['auto-discovered', 'multi-source', 'needs-review']
            });

  # å•ç‹¬è¿è¡Œå„çˆ¬è™«çš„ä½œä¸šï¼ˆç”¨äºè°ƒè¯•ï¼‰
  crawl-reddit:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.sources == 'reddit'

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Crawl Reddit
        run: |
          python scripts/multi_source_crawl.py \
            --sources reddit \
            --limit ${{ github.event.inputs.limit || '10' }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}

      - name: Commit and push changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          git commit -m "feat: Reddit çˆ¬å–å‘ç°æ–°èµ„æº [skip ci]"

          # æ¨é€å‰å…ˆæ‹‰å–æœ€æ–°å˜æ›´
          echo "æ‹‰å–æœ€æ–°å˜æ›´..."
          git pull --rebase origin ${{ github.ref_name }} || exit 0

          # æ¨é€å˜æ›´ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… æ¨é€æˆåŠŸ"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
                git pull --rebase origin ${{ github.ref_name }} || exit 0
              fi
            fi
          done

          echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼ˆéå…³é”®é”™è¯¯ï¼‰"
          exit 0  # ä¸å½±å“æ•´ä½“ workflow

  crawl-hackernews:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.sources == 'hackernews'

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Crawl Hacker News
        run: |
          python scripts/multi_source_crawl.py \
            --sources hackernews \
            --limit ${{ github.event.inputs.limit || '10' }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Commit and push changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          git commit -m "feat: Hacker News çˆ¬å–å‘ç°æ–°èµ„æº [skip ci]"

          # æ¨é€å‰å…ˆæ‹‰å–æœ€æ–°å˜æ›´
          echo "æ‹‰å–æœ€æ–°å˜æ›´..."
          git pull --rebase origin ${{ github.ref_name }} || exit 0

          # æ¨é€å˜æ›´ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
            if git push origin ${{ github.ref_name }}; then
              echo "âœ… æ¨é€æˆåŠŸ"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
                git pull --rebase origin ${{ github.ref_name }} || exit 0
              fi
            fi
          done

          echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯• $MAX_RETRIES æ¬¡ï¼ˆéå…³é”®é”™è¯¯ï¼‰"
          exit 0  # ä¸å½±å“æ•´ä½“ workflow
