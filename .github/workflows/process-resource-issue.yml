name: Process Resource Issue

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  process:
    runs-on: ubuntu-latest
    # Only run for issues with resource-submission label
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.issue.labels.*.name, 'resource-submission')

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get Issue info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber, issueBody;

            if (context.eventName === 'workflow_dispatch') {
              issueNumber = context.payload.inputs.issue_number;
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issueBody = issue.data.body;
            } else {
              issueNumber = context.issue.number;
              issueBody = context.payload.issue.body;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_body', issueBody);
            return { number: issueNumber, body: issueBody };

      - name: Process Issue
        id: process
        run: |
          python scripts/process_issue.py \
            --issue-number "${{ steps.issue_info.outputs.issue_number }}"
        env:
          ISSUE_BODY: ${{ steps.issue_info.outputs.issue_body }}
          LANG: zh_CN.UTF-8
          LC_ALL: zh_CN.UTF-8
        continue-on-error: true

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet candidates/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add candidates/
          git commit -m "feat: æ·»åŠ å€™é€‰èµ„æº from Issue #${{ steps.issue_info.outputs.issue_number }} [skip ci]"
          git push

      - name: Comment on success
        if: steps.process.outcome == 'success' && steps.verify_diff.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âœ… èµ„æºå·²åŠ å…¥å€™é€‰é˜Ÿåˆ—

æ„Ÿè°¢æ‚¨çš„æäº¤ï¼æ‚¨æäº¤çš„èµ„æºå·²è¢«æˆåŠŸè§£æå¹¶åŠ å…¥å€™é€‰é˜Ÿåˆ—ã€‚

### åç»­æ­¥éª¤
1. ğŸ” ç»´æŠ¤è€…å°†å®¡æ ¸æ‚¨çš„èµ„æº
2. âœ… å®¡æ ¸é€šè¿‡åï¼Œèµ„æºå°†è¢«æ·»åŠ åˆ°ä¸»åˆ—è¡¨
3. ğŸ“¢ æ‚¨ä¼šæ”¶åˆ°å®¡æ ¸ç»“æœçš„é€šçŸ¥

---
ğŸ¤– æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–æµç¨‹ç”Ÿæˆ`
            });

            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['pending-review']
            });

            // Remove needs-review label if exists
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'needs-review'
              });
            } catch (e) {
              // Label might not exist
            }

      - name: Comment on duplicate
        if: contains(steps.process.outputs.*, 'duplicate')
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âš ï¸ å‘ç°é‡å¤èµ„æº

æ‚¨æäº¤çš„èµ„æºé“¾æ¥å·²å­˜åœ¨äºæˆ‘ä»¬çš„åˆ—è¡¨ä¸­ã€‚

å¦‚æœæ‚¨è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªè¯¯åˆ¤ï¼Œè¯·ï¼š
1. æ£€æŸ¥èµ„æº URL æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤è¯¥èµ„æºç¡®å®ä¸ç°æœ‰èµ„æºä¸åŒ
3. åœ¨è¯„è®ºä¸­è¯´æ˜æƒ…å†µ

---
ğŸ¤– æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–æµç¨‹ç”Ÿæˆ`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['duplicate']
            });

      - name: Comment on failure
        if: steps.process.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âŒ å¤„ç†å¤±è´¥

è‡ªåŠ¨å¤„ç†æ‚¨çš„èµ„æºæäº¤æ—¶é‡åˆ°é—®é¢˜ã€‚è¿™å¯èƒ½æ˜¯ç”±äºï¼š
- èµ„æºé“¾æ¥æ— æ³•è®¿é—®
- å¿…å¡«å­—æ®µç¼ºå¤±
- è¡¨å•æ ¼å¼é—®é¢˜

è¯·æ£€æŸ¥æ‚¨çš„æäº¤å†…å®¹ï¼Œç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½å·²æ­£ç¡®å¡«å†™ï¼Œç„¶åç¼–è¾‘ Issue é‡æ–°è§¦å‘å¤„ç†ã€‚

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç»´æŠ¤è€…ã€‚

---
ğŸ¤– æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–æµç¨‹ç”Ÿæˆ`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['processing-failed']
            });
